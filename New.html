
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase API Tester</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Define Inter font family and base styling */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .config-error {
            background-color: #fef2f2; border-color: #f87171; color: #b91c1c;
            font-weight: bold; text-align: center;
        }
    </style>
</head>
<body class="min-h-screen bg-gray-100 p-4 sm:p-8">

    <div id="app" class="w-full max-w-2xl mx-auto bg-white p-6 sm:p-10 rounded-2xl shadow-2xl border-t-4 border-indigo-500 space-y-8">
        <h1 class="text-3xl font-extrabold text-gray-900 text-center">Firebase Connection Tester</h1>
        <p class="text-sm text-center text-gray-500">Tests successful authentication and Firestore read/write capabilities.</p>

        <!-- Configuration Status -->
        <div id="config-status" class="p-3 rounded-lg text-sm transition-all duration-300"></div>

        <!-- User Information -->
        <div id="user-info" class="bg-indigo-50 p-4 rounded-xl border border-indigo-200">
            <h2 class="text-xl font-semibold text-indigo-700 mb-2">User Status</h2>
            <div id="user-status-text" class="text-gray-800">
                Authenticating...
            </div>
        </div>

        <!-- Data Interaction Section -->
        <div id="data-section" class="space-y-4 hidden">
            <h2 class="text-xl font-semibold text-gray-700">Firestore Data Test (Private Path)</h2>
            <p class="text-sm text-gray-500">
                Path: artifacts/<span id="app-id-display"></span>/users/<span id="user-id-display"></span>/test/data
            </p>

            <div class="flex space-x-4">
                <button id="write-button" class="flex-1 bg-green-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-green-600 transition">
                    Write Test Data
                </button>
                <button id="read-button" class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-lg font-semibold shadow-md hover:bg-blue-600 transition">
                    Read Data Once
                </button>
            </div>

            <div id="data-display" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 min-h-[50px] font-mono text-sm whitespace-pre-wrap">
                Click "Read Data Once" to load the stored content.
            </div>
        </div>
        
        <!-- General Message Box -->
        <div id="message-box" class="hidden p-3 rounded-lg text-sm"></div>
    </div>

    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, serverTimestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // =====================================================================
        // üö® CRITICAL: FALLBACK CONFIGURATION (Required for local/standalone testing)
        // If the environment variables are NOT defined, you must replace the
        // placeholders below with your actual project details.
        // =====================================================================
        const hardcodedConfig = {
            // !!! REPLACE THIS WITH YOUR ACTUAL WEB API KEY !!!
            apiKey: "YOUR_WEB_API_KEY_HERE", 
            authDomain: "YOUR_AUTH_DOMAIN_HERE", 
            projectId: "YOUR_PROJECT_ID_HERE", 
            storageBucket: "YOUR_STORAGE_BUCKET_HERE",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID_HERE",
            appId: "YOUR_APP_ID_HERE"
        };
        
        // --- Core Setup Variables ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : hardcodedConfig;

        const appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId || 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        // =====================================================================

        // Initialize Global Firebase Instances
        let app;
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false;

        // DOM Elements (Initialized later in DOMContentLoaded)
        let configStatus;
        let userInfoText;
        let dataSection;
        let writeButton;
        let readButton;
        let dataDisplay;
        let messageBox;
        let appIdDisplay;
        let userIdDisplay;

        // --- Utility Functions ---

        // Display status messages
        function displayMessage(msg, type = 'info') {
            if (!messageBox) return; // Guard against running before DOM is ready
            messageBox.textContent = msg;
            messageBox.classList.remove('hidden', 'bg-red-100', 'border-red-400', 'text-red-800', 'bg-green-100', 'border-green-400', 'text-green-800', 'bg-yellow-100', 'border-yellow-400', 'text-yellow-800');
            
            if (type === 'error') {
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-800');
            } else if (type === 'success') {
                messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-800');
            } else {
                messageBox.classList.add('bg-yellow-100', 'border-yellow-400', 'text-yellow-800');
            }
            messageBox.classList.remove('hidden');
        }

        // Helper function to generate a simple UUID
        function generateSimpleUUID() {
            let dt = new Date().getTime();
            const uuid = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = (dt + Math.random() * 16) % 16 | 0;
                dt = Math.floor(dt / 16);
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
            return uuid;
        }
        
        // Function to create the Firestore document reference path
        function getTestDocRef() {
            // Private data path: /artifacts/{appId}/users/{userId}/test/data
            return doc(db, 'artifacts', appId, 'users', userId, 'test', 'data');
        }

        // --- Firebase Core Functions ---

        async function handleSignIn() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    userInfoText.innerHTML = `Signed in successfully (Custom Token). Waiting for state change...`;
                } else {
                    await signInAnonymously(auth);
                    userInfoText.innerHTML = `Signed in successfully (Anonymous). Waiting for state change...`;
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                userInfoText.innerHTML = `<span class="text-red-600 font-bold">Authentication Failed:</span> ${error.message}.`;
                dataSection.classList.add('hidden');
                
                if (error.message.includes('api-key-not-valid')) {
                    configStatus.innerHTML = `<div class="p-4 rounded-xl config-error border-2 border-dashed">
                        <p class="text-xl mb-2">üõë CONFIGURATION ERROR: Invalid API Key üõë</p>
                        <p class="text-sm">
                            The Web API Key used is incorrect. Please ensure the <code class="font-mono bg-red-200 px-1 rounded">apiKey</code> is correct.
                        </p>
                    </div>`;
                } else {
                    displayMessage(`Fatal Authentication Error: ${error.message}`, 'error');
                }
            }
        }

        function setupAuthStateListener() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userInfoText.innerHTML = `<span class="font-semibold text-green-600">Authenticated:</span> User ID: <code class="font-mono">${userId}</code>`;
                    appIdDisplay.textContent = appId;
                    userIdDisplay.textContent = userId;
                    dataSection.classList.remove('hidden');
                    // Automatically set up real-time listener after auth
                    setupRealtimeListener();
                } else {
                    // Fallback to a unique ID if auth fails for some reason
                    userId = generateSimpleUUID();
                    isAuthReady = false;
                    userInfoText.innerHTML = `<span class="font-semibold text-red-600">Unauthenticated:</span> Using temporary ID <code class="font-mono">${userId}</code>`;
                    dataSection.classList.add('hidden');
                }
            });
        }

        function setupRealtimeListener() {
            if (!isAuthReady) return;
            const docRef = getTestDocRef();

            // Set up real-time listener
            onSnapshot(docRef, (docSnap) => {
                const now = new Date().toLocaleTimeString();
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    let displayContent = JSON.stringify(data, null, 2);
                    dataDisplay.textContent = `[Updated @ ${now}]\n\n` + displayContent;
                    displayMessage('Real-time data update received!', 'info');
                } else {
                    dataDisplay.textContent = `[Updated @ ${now}]\n\nNo document found at path.`;
                }
            }, (error) => {
                console.error("Firestore Listener Error:", error);
                displayMessage(`Real-time Listener Failed. Check Firestore Rules. Error: ${error.message}`, 'error');
                dataDisplay.textContent = `ERROR: Failed to listen for data. Check console.`;
            });
        }

        // --- Data Interaction Handlers ---

        async function writeTestData() {
            if (!isAuthReady) {
                displayMessage('Authentication not ready. Please wait.', 'error');
                return;
            }

            const docRef = getTestDocRef();
            const payload = {
                message: `Test message written by user ${userId} at ${new Date().toISOString()}`,
                userId: userId,
                timestamp: serverTimestamp(),
                testValue: Math.floor(Math.random() * 100)
            };

            try {
                await setDoc(docRef, payload);
                displayMessage('Test data successfully written!', 'success');
            } catch (error) {
                console.error("Write Error:", error);
                displayMessage(`Failed to write data. Check Firestore Rules. Error: ${error.message}`, 'error');
            }
        }

        async function readDataOnce() {
            if (!isAuthReady) {
                displayMessage('Authentication not ready. Please wait.', 'error');
                return;
            }

            const docRef = getTestDocRef();

            try {
                const docSnap = await getDoc(docRef);
                const now = new Date().toLocaleTimeString();
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    dataDisplay.textContent = `[One-time Read @ ${now}]\n\n` + JSON.stringify(data, null, 2);
                    displayMessage('One-time read successful!', 'success');
                } else {
                    dataDisplay.textContent = `[One-time Read @ ${now}]\n\nDocument does not exist.`;
                    displayMessage('Document not found.', 'info');
                }
            } catch (error) {
                console.error("Read Error:", error);
                displayMessage(`Failed to read data. Check Firestore Rules. Error: ${error.message}`, 'error');
            }
        }

        // --- Main Initialization (Run when DOM is fully loaded) ---
        document.addEventListener('DOMContentLoaded', function() {
            // Map DOM elements now that they are guaranteed to exist
            configStatus = document.getElementById('config-status');
            userInfoText = document.getElementById('user-status-text');
            dataSection = document.getElementById('data-section');
            writeButton = document.getElementById('write-button');
            readButton = document.getElementById('read-button');
            dataDisplay = document.getElementById('data-display');
            messageBox = document.getElementById('message-box');
            appIdDisplay = document.getElementById('app-id-display');
            userIdDisplay = document.getElementById('user-id-display');


            // Final check for placeholders if running outside the canvas
            if (typeof __firebase_config === 'undefined' && firebaseConfig.apiKey === "YOUR_WEB_API_KEY_HERE") {
                configStatus.innerHTML = `<div class="p-4 rounded-xl config-error border-2 border-dashed">
                    <p class="text-xl mb-2">üõë CONFIGURATION REQUIRED üõë</p>
                    <p class="text-sm">
                        Please update the **apiKey** in the **hardcodedConfig** object 
                        to your actual Firebase Web API Key to test locally.
                    </p>
                </div>`;
                userInfoText.innerHTML = `<span class="text-red-600 font-bold">Initialization Stopped.</span> Check configuration.`;
                return;
            }

            try {
                // Initialize Firebase services
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                // Set debug logging to capture any issues
                setLogLevel('Debug'); 

                // Start the sign-in process and listen for state changes
                handleSignIn();
                setupAuthStateListener();

                // Add event listeners to buttons, only if they exist
                if (writeButton) {
                    writeButton.addEventListener('click', writeTestData);
                }
                if (readButton) {
                    readButton.addEventListener('click', readDataOnce);
                }

                configStatus.innerHTML = `<div class="p-3 bg-green-100 border border-green-400 text-green-800 rounded-lg">
                    <span class="font-semibold">Config Success:</span> Firebase loaded using ${typeof __firebase_config !== 'undefined' ? 'Environment Variables' : 'Hardcoded Fallback'}.
                </div>`;

            } catch (error) {
                console.error("Initialization Failed:", error);
                displayMessage(`Initialization Failed: ${error.message}`, 'error');
                configStatus.innerHTML = `<div class="p-4 rounded-xl config-error border-2 border-dashed">
                    <p class="text-xl mb-2">‚ùå INITIALIZATION FAILURE ‚ùå</p>
                    <p class="text-sm">
                        A critical error occurred while initializing Firebase. Check the console for details and ensure your config object is fully complete and correct.
                    </p>
                </div>`;
            }
        });

    </script>
</body>
</html>
